name: Deploy WordPress

on:
  push:
    branches: [main]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up SSH Key
        run: |
          echo "${{ secrets.DEPLOY_KEY }}" > key.pem
          chmod 400 key.pem

      - name: Deploy WordPress via Bastion Host
        env:
          DB_ADDRESS: ${{ secrets.DB_ADDRESS }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          set -e

          echo "ðŸ“‹ App Server IPs: ${{ secrets.APP_SERVER_IPS }}"
          IFS=',' read -ra HOSTS <<< "${{ secrets.APP_SERVER_IPS }}"

          for host in "${HOSTS[@]}"; do
            echo "ðŸš€ Deploying to $host via bastion ${{ secrets.BASTION_IP }}..."

            echo "ðŸ”— Testing SSH connection..."
            ssh -o ProxyJump=${{ secrets.BASTION_USER }}@${{ secrets.BASTION_IP }} \
                -i key.pem -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
                ${{ secrets.DEPLOY_USER }}@$host "echo 'âœ… Connected to $host'"

            echo "ðŸ“¤ Copying WordPress files to $host..."
            scp -o ProxyJump=${{ secrets.BASTION_USER }}@${{ secrets.BASTION_IP }} \
                -i key.pem -o StrictHostKeyChecking=no wordpress/wordpress-files.tar.gz \
                ${{ secrets.DEPLOY_USER }}@$host:/tmp/

            scp -o ProxyJump=${{ secrets.BASTION_USER }}@${{ secrets.BASTION_IP }} \
                -i key.pem -o StrictHostKeyChecking=no wordpress.sql \
                ${{ secrets.DEPLOY_USER }}@$host:/tmp/

            echo "âš™ï¸ Running remote deployment commands on $host..."
            ssh -o ProxyJump=${{ secrets.BASTION_USER }}@${{ secrets.BASTION_IP }} \
                -i key.pem -o StrictHostKeyChecking=no \
                ${{ secrets.DEPLOY_USER }}@$host 'bash -s' <<'EOF'
              set -e

              echo "ðŸ“¦ Unpacking WordPress..."
              sudo systemctl stop httpd || true
              sudo rm -rf /var/www/html/*
              sudo mkdir -p /var/www/html
              sudo tar -xzf /tmp/wordpress-files.tar.gz -C /var/www/html/
              sudo chown -R apache:apache /var/www/html/

              echo "ðŸ“ Creating .env file..."
              sudo bash -c "cat > /var/www/html/.env" <<EOT
              DB_NAME='${DB_NAME}'
              DB_USER='${DB_USER}'
              DB_PASSWORD='${DB_PASSWORD}'
              DB_ADDRESS='${DB_ADDRESS}'
              EOT
              sudo chown apache:apache /var/www/html/.env
              sudo chmod 640 /var/www/html/.env

              echo "ðŸ›¢ï¸ Importing MySQL dump..."
              mysql -h "${DB_ADDRESS}" -u "${DB_USER}" -p"${DB_PASSWORD}" "${DB_NAME}" < /tmp/wordpress.sql

              echo "âœ… Restarting HTTPD"
              sudo systemctl start httpd

              echo "ðŸ§¹ Cleaning up..."
              rm -f /tmp/wordpress-files.tar.gz /tmp/wordpress.sql
            EOF
          done
